{% extends "base.html" %}

{% block title %}
<a class="header-link-home" href="{{ url_for('chat.index') }}">WebChat</a> 
<a class="header-small" href="{{ url_for('chat.view_area', area_id=area.id) }}">{{ area.topic }}</a>
{% endblock %}

{% block navbar %}
<!-- Add Thread Button -->
<button id="createAreaBtn" class="modern-button green-border">New Thread</button>
{% if is_admin and area.is_secret %}
<!-- Manage Area Access Button -->
<button id="manageAreaAccessBtn" class="modern-button green-border">Manage Area Access</button>
{% endif %}
{% if is_admin %}
<!-- Delete Area Button -->
<form action="{{ url_for('chat.delete_area', area_id=area.id) }}" method="post" style="display: inline;">
    <input type="hidden" name="area_id" value="{{ area.id }}">
    <button type="submit" class="modern-button red-border">Delete Area</button>
</form>
{% endif %}
{% endblock %}

{% block content %}
<section class="discussion-areas">
    {% for thread in area.threads %}
    <a href="{{ url_for('chat.view_thread', thread_id=thread.id) }}" class="discussion-area-link">
        <article class="discussion-area green-border">
            <h2>{{ thread.title }}</h2>
            <p>Messages: <span class="message-count">{{ thread.message_count }}</span></p>
            <p>Last: <time class="last-message">{{ thread.last_message }}</time></p>
        </article>
    </a>
    {% endfor %}
</section>
<div id="createAreaModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-btn-create-area">&times;</span>
        <form action="{{ url_for('chat.view_area', area_id=area.id) }}" method="post" id="createAreaForm">
            <h2>Create New Thread</h2>
            <div class="form-group">
                <label for="topicName">Title</label>
                <input type="text" id="topicName" name="title" required>
                <label for="message">First message</label>
                <textarea name="message" rows="5" required></textarea>
            </div>
            <div class="cf-turnstile" data-sitekey="{{ turnstile_sitekey }}"></div>
            <button type="submit" class="modern-button">Create</button>
        </form>
    </div>
</div>
<!-- Manage Area Access Modal -->
<div id="manageAreaAccessModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-btn-manage-area">&times;</span>
        <form action="{{ url_for('chat.manage_area_access') }}" method="post" id="manageAreaAccessForm">
            <h2>Manage Area Access</h2>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username">
            </div>
            <input type="hidden" name="area_id" value="{{ area.id }}">
            <button type="submit" name="action" value="add" class="modern-button">Add User</button>
            <button type="submit" name="action" value="remove" class="modern-button">Remove User</button>
            <div id="userList">
                <h3>Users with Access</h3>
                <ul>
                    {% for user in access_list %}
                    <li>{{ user.username }}</li>
                    {% endfor %}
                </ul>
            </div>
        </form>
    </div>
</div>

<script>
    // Get the modal
    var modal = document.getElementById("createAreaModal");

    // Get the button that opens the modal
    var btn = document.getElementById("createAreaBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementById("close-btn-create-area");

    // When the user clicks the button, open the modal 
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
<script>
    // Existing modal script

    // Get the manage area access modal
    var manageModal = document.getElementById("manageAreaAccessModal");

    // Get the button that opens the manage area access modal
    var manageBtn = document.getElementById("manageAreaAccessBtn");

    // Get the <span> element that closes the manage area access modal
    var span = document.getElementById("close-btn-manage-area");

    // When the user clicks the button, open the manage area access modal 
    manageBtn.onclick = function() {
        manageModal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the manage area access modal
    span.onclick = function() {
        manageModal.style.display = "none";
    }

    // Reuse the existing window.onclick function to include the new modal
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        } else if (event.target == manageModal) {
            manageModal.style.display = "none";
        }
    }
</script>
{% endblock %}